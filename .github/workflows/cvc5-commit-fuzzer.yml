name: CVC5 Commit Fuzzer

on:
  workflow_dispatch:
    inputs:
      cvc5_commit_hash:
        description: 'Optional: CVC5 commit hash to analyze (defaults to HEAD)'
        required: false
        type: string
      stop_buffer_minutes:
        description: 'Optional: Minutes before timeout to stop fuzzing (default: 5)'
        required: false
        type: number
        default: 5

jobs:
  commit-fuzzer:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.extract-tests.outputs.matrix }}
      total_tests: ${{ steps.extract-tests.outputs.total_tests }}
      total_jobs: ${{ steps.extract-tests.outputs.total_jobs }}
      commit_hash: ${{ steps.get-commit.outputs.commit_hash }}
    permissions:
      actions: read
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Install LLVM/Clang 17
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: '17'

      - name: Add LLVM to PATH
        run: echo "${{ env.LLVM_PATH }}/bin" >> $GITHUB_PATH

      - name: Export LIBCLANG_PATH
        run: echo "LIBCLANG_PATH=${{ env.LLVM_PATH }}/lib" >> $GITHUB_ENV

      - name: Install system development packages
        run: |
          echo "Installing essential development packages..."
          sudo apt-get update
          
          # Install ONLY GCC 14 and essential packages (remove conflicting versions)
          sudo apt-get install -y \
            build-essential \
            libc6-dev \
            gcc \
            g++ \
            binutils \
            libstdc++-14-dev \
            libc++-dev \
            libc++abi-dev \
            zlib1g \
            zlib1g-dev
          
          echo "Installation completed"
      
      - name: Install Python dependencies
        run: |
          pip install gitpython unidiff "libclang==17.0.6"

      - name: Clone CVC5 repository
        run: |
          if [ -d "cvc5" ]; then
            echo "CVC5 directory already exists, skipping clone"
          else
            git clone https://github.com/cvc5/cvc5.git cvc5
          fi

      - name: Checkout specific commit if provided
        if: inputs.cvc5_commit_hash != ''
        working-directory: cvc5
        run: |
          echo "ðŸ”¨ Checking out provided commit: ${{ inputs.cvc5_commit_hash }}"
          git fetch origin
          git checkout ${{ inputs.cvc5_commit_hash }}
          echo "Checked out commit: $(git rev-parse HEAD)"

      - name: Get CVC5 commit hash
        id: get-commit
        working-directory: cvc5
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "CVC5 commit hash: $COMMIT_HASH"

      - name: Download coverage binary and compile_commands.json
        id: download-coverage-binary
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          name: coverage-cvc5-${{ steps.get-commit.outputs.commit_hash }}
          path: artifacts
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: cvc5.yml
          branch: main

      - name: Extract coverage binary, headers, and compile_commands.json
        id: extract-coverage-binary
        run: |
          # Find artifacts.tar.gz
          ARTIFACT_FILE=""
          if [ -f "artifacts/artifacts.tar.gz" ]; then
            ARTIFACT_FILE="artifacts/artifacts.tar.gz"
          elif [ -f "artifacts/cvc5/build/artifacts.tar.gz" ]; then
            ARTIFACT_FILE="artifacts/cvc5/build/artifacts.tar.gz"
          fi
          
          if [ -n "$ARTIFACT_FILE" ]; then
            ./scripts/cvc5/extract_build_artifacts.sh "$ARTIFACT_FILE" cvc5/build true
            if [ -f "cvc5/build/bin/cvc5" ]; then
              echo "binary_available=true" >> $GITHUB_OUTPUT
            else
              echo "binary_available=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "WARNING: artifacts.tar.gz not found, will build as fallback"
            echo "binary_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Build cvc5 static binary with coverage (fallback)
        if: steps.extract-coverage-binary.outputs.binary_available != 'true'
        run: |
          echo "ðŸ”¨ Building CVC5 static binary with coverage as fallback (binary not available from artifacts)"
          # Set environment variables to ensure clang uses GCC 14 toolchain
          export CXX="clang++ --gcc-toolchain=/usr"
          export CC="clang --gcc-toolchain=/usr"
          ./scripts/cvc5/build.sh --static --coverage
      
      - name: Download coverage map
        uses: dawidd6/action-download-artifact@v6
        with:
          name: coverage-mapping
          path: .
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: cvc5-coverage-mapper.yml
          branch: main
      
      - name: Extract coverage map
        run: |
          gunzip coverage_mapping.json.gz
          ls -la coverage_mapping.json

      - name: Run Commit Fuzzer and create matrix
        id: extract-tests
        working-directory: cvc5
        env:
          SKIP_COVERAGE_ENFORCEMENT: "true"
          MAX_JOBS: 10
          CVC5_COMMIT_HASH: ${{ steps.get-commit.outputs.commit_hash }}
        run: |
          # Run commit fuzzer with matrix output (1 commit instead of 50)
          # Start with 10 jobs max (for testing)
          # Tests per job is calculated dynamically to fit within MAX_JOBS
          # To scale: change MAX_JOBS to 200+ (will automatically adjust tests_per_job)
          ${{ github.workspace }}/scripts/cvc5/commit_fuzzer/run_prepare_commit_fuzzer.sh \
            --python-script ${{ github.workspace }}/scripts/cvc5/commit_fuzzer/prepare_commit_fuzzer.py \
            --coverage-file ../coverage_mapping.json \
            --compile-commands build \
            --output-matrix fuzzer_matrix.json \
            --max-jobs $MAX_JOBS \
            1
          
          if [ ! -f "fuzzer_matrix.json" ]; then
            echo "No matrix file created, setting empty outputs"
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "total_tests=0" >> $GITHUB_OUTPUT
            echo "total_jobs=0" >> $GITHUB_OUTPUT
            echo "No matrix file created, ending job"
            exit 0
          fi
          
          # Read matrix data and output to GitHub Actions
          MATRIX=$(jq -c '.matrix' fuzzer_matrix.json)
          TOTAL_TESTS=$(jq -r '.total_tests' fuzzer_matrix.json)
          TOTAL_JOBS=$(jq -r '.total_jobs' fuzzer_matrix.json)
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "total_jobs=$TOTAL_JOBS" >> $GITHUB_OUTPUT
          
          echo "Matrix created with $TOTAL_JOBS jobs for $TOTAL_TESTS tests"

  fuzzer-jobs:
    needs: commit-fuzzer
    if: needs.commit-fuzzer.result == 'success' && needs.commit-fuzzer.outputs.total_tests != '' && needs.commit-fuzzer.outputs.total_tests != '0'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.commit-fuzzer.outputs.matrix) }}
    permissions:
      actions: read
      contents: read
    
    steps:
      - name: Record job start time
        run: echo "$(date +%s)" > /tmp/job_start_${GITHUB_RUN_ID}_${{ matrix.job_id }}.txt
      
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 \
            python3-pip \
            unzip \
            wget

      - name: Install fuzzing dependencies
        run: |
          pip install antlr4-python3-runtime==4.9.2
          pip install z3-solver
          pip install psutil
          git clone https://github.com/testsmt/yinyang.git
          cd yinyang
          pip install -e .

      - name: Download solver binaries
        run: |
          mkdir -p ${{ github.workspace }}/solvers
          
          # Download cvc4-1.6
          wget -q https://cvc4.cs.stanford.edu/downloads/builds/x86_64-linux-opt/cvc4-1.6-x86_64-linux-opt \
            -O ${{ github.workspace }}/solvers/cvc4-1.6
          chmod +x ${{ github.workspace }}/solvers/cvc4-1.6
          
          # Download z3-4.8.7
          wget -q https://github.com/Z3Prover/z3/releases/download/z3-4.8.7/z3-4.8.7-x64-ubuntu-16.04.zip -O /tmp/z3.zip
          unzip -q /tmp/z3.zip -d /tmp
          cp /tmp/z3-4.8.7-x64-ubuntu-16.04/bin/z3 ${{ github.workspace }}/solvers/z3-4.8.7
          cp /tmp/z3-4.8.7-x64-ubuntu-16.04/bin/libz3.so ${{ github.workspace }}/solvers/
          chmod +x ${{ github.workspace }}/solvers/z3-4.8.7
          rm -rf /tmp/z3.zip /tmp/z3-4.8.7-x64-ubuntu-16.04

      - name: Clone CVC5 repository
        run: |
          if [ -d "cvc5" ]; then
            echo "CVC5 directory already exists, skipping clone"
          else
            git clone https://github.com/cvc5/cvc5.git cvc5
          fi

      - name: Checkout same commit as first job
        working-directory: cvc5
        run: |
          git fetch origin
          git checkout ${{ needs.commit-fuzzer.outputs.commit_hash }}
          echo "Checked out commit: $(git rev-parse HEAD)"

      - name: Download production binary
        id: download-production-binary
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          name: cvc5-${{ needs.commit-fuzzer.outputs.commit_hash }}
          path: artifacts
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: cvc5.yml
          branch: main

      - name: Extract production binary
        id: extract-production-binary
        run: |
          # Find artifacts.tar.gz (production binary doesn't need headers)
          ARTIFACT_FILE=""
          if [ -f "artifacts/artifacts.tar.gz" ]; then
            ARTIFACT_FILE="artifacts/artifacts.tar.gz"
          elif [ -f "artifacts/cvc5/build/artifacts.tar.gz" ]; then
            ARTIFACT_FILE="artifacts/cvc5/build/artifacts.tar.gz"
          fi
          
          if [ -n "$ARTIFACT_FILE" ]; then
            ./scripts/cvc5/extract_build_artifacts.sh "$ARTIFACT_FILE" cvc5/build false
            if [ -f "cvc5/build/bin/cvc5" ]; then
              echo "binary_available=true" >> $GITHUB_OUTPUT
            else
              echo "binary_available=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "WARNING: artifacts.tar.gz not found, will build as fallback"
            echo "binary_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Build cvc5 static binary (fallback)
        if: steps.extract-production-binary.outputs.binary_available != 'true'
        run: |
          echo "ðŸ”¨ Building CVC5 static binary as fallback (binary not available from artifacts)"
          ./scripts/cvc5/build.sh --static

      - name: Verify solver binaries
        run: |
          ${{ github.workspace }}/solvers/cvc4-1.6 --version
          ${{ github.workspace }}/solvers/z3-4.8.7 --version
          z3 --version

      - name: Run Simple Fuzzer on assigned tests
        working-directory: cvc5
        run: |
          JOB_START=$(cat /tmp/job_start_${GITHUB_RUN_ID}_${{ matrix.job_id }}.txt)
          ${{ github.workspace }}/scripts/cvc5/commit_fuzzer/simple_commit_fuzzer.py \
            --tests-json '${{ toJson(matrix.tests) }}' \
            --job-id '${{ matrix.job_id }}' \
            --tests-root 'test/regress/cli' \
            --job-start-time "$JOB_START" \
            --stop-buffer-minutes ${{ inputs.stop_buffer_minutes || 5 }} \
            --iterations 2147483647 \
            --z3-old-path ${{ github.workspace }}/solvers/z3-4.8.7 \
            --cvc4-path ${{ github.workspace }}/solvers/cvc4-1.6 \
            --cvc5-path ./build/bin/cvc5
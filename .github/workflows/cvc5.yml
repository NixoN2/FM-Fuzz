name: Build CVC5

on:
  workflow_dispatch:
    inputs:
      cvc5_commit_hash:
        description: 'Optional: CVC5 commit hash to build (skips upstream check)'
        required: false
        type: string
  schedule:
    - cron: '0 * * * *'  # Run every hour

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      build_needed: ${{ steps.check-upstream.outputs.build_needed }}
      sha: ${{ steps.check-upstream.outputs.sha }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Handle provided commit hash
        if: inputs.cvc5_commit_hash != ''
        id: provided-commit
        run: |
          echo "ðŸ”¨ Building provided commit hash: ${{ inputs.cvc5_commit_hash }}"
          echo "build_needed=true" >> $GITHUB_OUTPUT
          echo "sha=${{ inputs.cvc5_commit_hash }}" >> $GITHUB_OUTPUT
      
      - name: Download last built SHA from artifacts
        if: inputs.cvc5_commit_hash == ''
        uses: dawidd6/action-download-artifact@v6
        id: download-sha
        continue-on-error: true
        with:
          name: cvc5-last-sha
          path: .cache
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: cvc5.yml
      
      - name: Check for upstream changes
        if: inputs.cvc5_commit_hash == ''
        id: check-upstream
        run: |
          ./scripts/check-upstream.sh cvc5 https://github.com/cvc5/cvc5.git
          echo "build_needed=$(cat .build_status | grep build_needed | cut -d'=' -f2)" >> $GITHUB_OUTPUT
          echo "sha=$(cat .build_status | grep sha | cut -d'=' -f2)" >> $GITHUB_OUTPUT
          # Ensure cache directory exists and file is created
          mkdir -p .cache
          if [ ! -f ".cache/cvc5_last_sha" ]; then
            echo "$(cat .build_status | grep sha | cut -d'=' -f2)" > .cache/cvc5_last_sha
          fi
      
      - name: Upload last built SHA artifact
        if: inputs.cvc5_commit_hash == ''
        uses: actions/upload-artifact@v4
        with:
          name: cvc5-last-sha
          path: .cache/cvc5_last_sha
          retention-days: 30
          if-no-files-found: ignore
      
      - name: Set outputs for provided commit
        if: inputs.cvc5_commit_hash != ''
        run: |
          echo "build_needed=true" >> $GITHUB_OUTPUT
          echo "sha=${{ inputs.cvc5_commit_hash }}" >> $GITHUB_OUTPUT

  build-static:
    needs: check-upstream
    if: needs.check-upstream.outputs.build_needed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Prepare CVC5 for specific commit
        if: inputs.cvc5_commit_hash != ''
        run: |
          echo "ðŸ”¨ Building specific commit: ${{ inputs.cvc5_commit_hash }}"
          if [ -d "cvc5" ]; then
            rm -rf cvc5
          fi
          git clone https://github.com/cvc5/cvc5.git cvc5
          cd cvc5
          git checkout ${{ inputs.cvc5_commit_hash }}
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..
      
      - name: Build CVC5 static binary
        run: ./scripts/cvc5/build.sh --static
      
      - name: Get commit hash
        id: get-commit
        working-directory: cvc5
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "CVC5 commit hash: $COMMIT_HASH"
      
      - name: Measure binary size
        working-directory: cvc5
        run: |
          if [ -f "./build/bin/cvc5" ]; then
            BINARY_SIZE=$(du -h ./build/bin/cvc5 | cut -f1)
            BINARY_SIZE_BYTES=$(stat -f%z ./build/bin/cvc5 2>/dev/null || stat -c%s ./build/bin/cvc5 2>/dev/null)
            echo "Binary size: $BINARY_SIZE ($BINARY_SIZE_BYTES bytes)"
            echo "binary_size=$BINARY_SIZE" >> $GITHUB_OUTPUT
            echo "binary_size_bytes=$BINARY_SIZE_BYTES" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Binary not found at ./build/bin/cvc5"
            exit 1
          fi
      
      - name: Compress binary with tar.gz
        working-directory: cvc5/build/bin
        run: |
          tar -czf cvc5.tar.gz cvc5
          COMPRESSED_SIZE=$(du -h cvc5.tar.gz | cut -f1)
          echo "Compressed size: $COMPRESSED_SIZE"
      
      - name: Upload static binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: cvc5-${{ steps.get-commit.outputs.commit_hash }}
          path: cvc5/build/bin/cvc5.tar.gz
          retention-days: 7

  build-static-coverage:
    needs: check-upstream
    if: needs.check-upstream.outputs.build_needed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Clean any previous build
        run: |
          if [ -d "cvc5/build" ]; then
            rm -rf cvc5/build
            echo "Cleaned previous build directory"
          fi
      
      - name: Prepare CVC5 for specific commit
        if: inputs.cvc5_commit_hash != ''
        run: |
          echo "ðŸ”¨ Building specific commit: ${{ inputs.cvc5_commit_hash }}"
          if [ -d "cvc5" ]; then
            rm -rf cvc5
          fi
          git clone https://github.com/cvc5/cvc5.git cvc5
          cd cvc5
          git checkout ${{ inputs.cvc5_commit_hash }}
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..
      
      - name: Build CVC5 static binary with coverage
        run: ./scripts/cvc5/build.sh --static --coverage
      
      - name: Get commit hash
        id: get-commit
        working-directory: cvc5
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "CVC5 commit hash: $COMMIT_HASH"
      
      - name: Measure binary size
        working-directory: cvc5
        run: |
          if [ -f "./build/bin/cvc5" ]; then
            BINARY_SIZE=$(du -h ./build/bin/cvc5 | cut -f1)
            BINARY_SIZE_BYTES=$(stat -f%z ./build/bin/cvc5 2>/dev/null || stat -c%s ./build/bin/cvc5 2>/dev/null)
            echo "Binary size: $BINARY_SIZE ($BINARY_SIZE_BYTES bytes)"
            echo "binary_size=$BINARY_SIZE" >> $GITHUB_OUTPUT
            echo "binary_size_bytes=$BINARY_SIZE_BYTES" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Binary not found at ./build/bin/cvc5"
            exit 1
          fi
      
      - name: Compress binary with tar.gz
        working-directory: cvc5/build/bin
        run: |
          tar -czf cvc5.tar.gz cvc5
          COMPRESSED_SIZE=$(du -h cvc5.tar.gz | cut -f1)
          echo "Compressed size: $COMPRESSED_SIZE"
      
      - name: Upload static coverage binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-cvc5-${{ steps.get-commit.outputs.commit_hash }}
          path: cvc5/build/bin/cvc5.tar.gz
          retention-days: 7

  skip-build:
    needs: check-upstream
    if: needs.check-upstream.outputs.build_needed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Skip build (up to date)
        run: echo "âœ… CVC5 is up to date - skipping build"

name: CVC5 Commit Coverage Analysis

on:
  workflow_dispatch:

jobs:
  commit-coverage-analysis:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Set up LLVM/Clang 17
        id: llvm
        uses: actions/setup-llvm@v1
        with:
          version: '17'

      - name: Add LLVM to PATH
        run: echo "${{ steps.llvm.outputs.llvm-path }}/bin" >> $GITHUB_PATH

      - name: Export LIBCLANG_PATH
        run: echo "LIBCLANG_PATH=${{ steps.llvm.outputs.llvm-path }}/lib" >> $GITHUB_ENV

      - name: Verify Clang
        run: |
          clang++ --version
          clang -print-resource-dir
      
      - name: Build CVC5 with coverage
        run: |
          ./scripts/cvc5/build.sh --coverage
      
      - name: Download coverage mapping artifact from latest successful run
        uses: dawidd6/action-download-artifact@v3
        with:
          name: coverage-mapping-final
          path: .
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: cvc5-coverage-analysis.yml
      
      - name: Extract coverage mapping
        run: |
          gunzip coverage_mapping_merged.json.gz
          ls -la coverage_mapping_merged.json
      
      - name: Install Python dependencies
        run: |
          pip install gitpython unidiff "clang==17.0.6" "libclang==17.0.6"
      
      - name: Run commit coverage analysis
        run: |
          cd cvc5
          ${{ github.workspace }}/scripts/cvc5/run_commit_coverage_analysis.sh 15 ${{ github.workspace }}/scripts/cvc5/commit_coverage_analyzer.py ../coverage_mapping_merged.json
